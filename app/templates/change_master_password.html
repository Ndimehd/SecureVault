{% extends "base.html" %}

{% block title %}Changer le mot de passe maître - SecureVault{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar">
            <div class="sidebar-sticky">
                <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                    <span>Sécurité</span>
                </h6>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.dashboard') }}">
                            <i class="fas fa-tachometer-alt"></i>
                            Tableau de bord
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.security_settings') }}">
                            <i class="fas fa-shield-alt"></i>
                            Paramètres de sécurité
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('main.change_master_password') }}">
                            <i class="fas fa-key"></i>
                            Changer mot de passe maître
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main content -->
        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="fas fa-key text-warning"></i>
                    Changer le mot de passe maître
                </h1>
            </div>

            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">
                                <i class="fas fa-exclamation-triangle"></i>
                                Modification du mot de passe maître
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <strong>Important :</strong> Changer votre mot de passe maître va re-chiffrer toutes vos données. 
                                Cette opération peut prendre quelques instants selon le nombre d'entrées.
                            </div>

                            <form id="changeMasterPasswordForm">
                                <div class="form-group">
                                    <label for="currentMasterPassword">
                                        <i class="fas fa-lock"></i>
                                        Mot de passe maître actuel *
                                    </label>
                                    <div class="input-group">
                                        <input type="password" 
                                               class="form-control" 
                                               id="currentMasterPassword" 
                                               name="current_master_password" 
                                               required
                                               placeholder="Entrez votre mot de passe maître actuel">
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary" 
                                                    type="button" 
                                                    id="toggleCurrentPassword">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="newMasterPassword">
                                        <i class="fas fa-key"></i>
                                        Nouveau mot de passe maître *
                                    </label>
                                    <div class="input-group">
                                        <input type="password" 
                                               class="form-control" 
                                               id="newMasterPassword" 
                                               name="new_master_password" 
                                               required
                                               placeholder="Entrez un nouveau mot de passe maître fort">
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary" 
                                                    type="button" 
                                                    id="toggleNewPassword">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <div class="progress" style="height: 5px;">
                                            <div class="progress-bar" 
                                                 id="passwordStrengthBar" 
                                                 role="progressbar" 
                                                 style="width: 0%">
                                            </div>
                                        </div>
                                        <small id="passwordStrengthText" class="text-muted">
                                            Force du mot de passe
                                        </small>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="confirmMasterPassword">
                                        <i class="fas fa-check-double"></i>
                                        Confirmer le nouveau mot de passe *
                                    </label>
                                    <div class="input-group">
                                        <input type="password" 
                                               class="form-control" 
                                               id="confirmMasterPassword" 
                                               name="confirm_master_password" 
                                               required
                                               placeholder="Confirmez votre nouveau mot de passe maître">
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary" 
                                                    type="button" 
                                                    id="toggleConfirmPassword">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="passwordMatchWarning" class="mt-1" style="display: none;">
                                        <small class="text-danger">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Les mots de passe ne correspondent pas
                                        </small>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="form-check">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="confirmOperation" 
                                               required>
                                        <label class="form-check-label" for="confirmOperation">
                                            Je comprends que cette opération va re-chiffrer toutes mes données et que je ne pourrai plus accéder à mes entrées avec l'ancien mot de passe maître.
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group text-center">
                                    <button type="submit" 
                                            class="btn btn-warning btn-lg" 
                                            id="submitBtn">
                                        <i class="fas fa-sync-alt"></i>
                                        Changer le mot de passe maître
                                    </button>
                                    <a href="{{ url_for('main.security_settings') }}" 
                                       class="btn btn-secondary btn-lg ml-2">
                                        <i class="fas fa-times"></i>
                                        Annuler
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Modal de progression -->
<div class="modal fade" id="progressModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-warning mb-3" role="status">
                    <span class="sr-only">Chargement...</span>
                </div>
                <h5>Re-chiffrement en cours...</h5>
                <p class="text-muted">Veuillez patienter pendant que nous sécurisons vos données avec le nouveau mot de passe maître.</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('changeMasterPasswordForm');
    const currentPasswordInput = document.getElementById('currentMasterPassword');
    const newPasswordInput = document.getElementById('newMasterPassword');
    const confirmPasswordInput = document.getElementById('confirmMasterPassword');
    const passwordMatchWarning = document.getElementById('passwordMatchWarning');
    const submitBtn = document.getElementById('submitBtn');
    const progressModal = $('#progressModal');

    // Toggle password visibility
    document.getElementById('toggleCurrentPassword').addEventListener('click', function() {
        togglePasswordVisibility('currentMasterPassword', this);
    });

    document.getElementById('toggleNewPassword').addEventListener('click', function() {
        togglePasswordVisibility('newMasterPassword', this);
    });

    document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
        togglePasswordVisibility('confirmMasterPassword', this);
    });

    function togglePasswordVisibility(inputId, button) {
        const input = document.getElementById(inputId);
        const icon = button.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    // Password strength checker
    newPasswordInput.addEventListener('input', function() {
        checkPasswordStrength(this.value);
    });

    function checkPasswordStrength(password) {
        const strengthBar = document.getElementById('passwordStrengthBar');
        const strengthText = document.getElementById('passwordStrengthText');
        
        fetch(`/check-password-strength?password=${encodeURIComponent(password)}`)
            .then(response => response.json())
            .then(data => {
                const percentage = (data.score / 6) * 100;
                strengthBar.style.width = percentage + '%';
                strengthBar.className = `progress-bar bg-${data.color === 'red' ? 'danger' : data.color === 'orange' ? 'warning' : 'success'}`;
                strengthText.textContent = `Force: ${data.strength}`;
                
                if (data.feedback && data.feedback.length > 0) {
                    strengthText.textContent += ` - ${data.feedback.join(', ')}`;
                }
            })
            .catch(error => {
                console.error('Erreur lors de la vérification de la force du mot de passe:', error);
            });
    }

    // Password match validation
    function checkPasswordMatch() {
        if (confirmPasswordInput.value && newPasswordInput.value !== confirmPasswordInput.value) {
            passwordMatchWarning.style.display = 'block';
            confirmPasswordInput.classList.add('is-invalid');
            return false;
        } else {
            passwordMatchWarning.style.display = 'none';
            confirmPasswordInput.classList.remove('is-invalid');
            return true;
        }
    }

    confirmPasswordInput.addEventListener('input', checkPasswordMatch);
    newPasswordInput.addEventListener('input', checkPasswordMatch);

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!checkPasswordMatch()) {
            return;
        }

        if (newPasswordInput.value.length < 8) {
            alert('Le nouveau mot de passe maître doit contenir au moins 8 caractères.');
            return;
        }

        if (currentPasswordInput.value === newPasswordInput.value) {
            alert('Le nouveau mot de passe maître doit être différent de l\'ancien.');
            return;
        }

        // Afficher le modal de progression
        progressModal.modal('show');
        submitBtn.disabled = true;

        const formData = {
            current_master_password: currentPasswordInput.value,
            new_master_password: newPasswordInput.value
        };

        fetch('/change-master-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            progressModal.modal('hide');
            
            if (data.success) {
                alert('Mot de passe maître changé avec succès !');
                window.location.href = '/dashboard';
            } else {
                alert('Erreur: ' + (data.error || 'Une erreur est survenue'));
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            progressModal.modal('hide');
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors du changement du mot de passe maître.');
            submitBtn.disabled = false;
        });
    });
});
</script>

<style>
.sidebar {
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    z-index: 100;
    padding: 48px 0 0;
    box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
    background-color: #f8f9fa;
}

.sidebar-sticky {
    position: relative;
    top: 0;
    height: calc(100vh - 48px);
    padding-top: 0.5rem;
    overflow-x: hidden;
    overflow-y: auto;
}

.sidebar .nav-link {
    font-weight: 500;
    color: #333;
    padding: 0.75rem 1rem;
}

.sidebar .nav-link.active {
    color: #007bff;
    background-color: rgba(0, 123, 255, 0.1);
}

.sidebar .nav-link:hover {
    color: #007bff;
}

main {
    margin-left: 240px;
}

@media (max-width: 767.98px) {
    .sidebar {
        top: 5rem;
    }
    
    main {
        margin-left: 0;
    }
}

.card {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: none;
}

.progress {
    background-color: #e9ecef;
}

.input-group-append .btn {
    border-left: none;
}

.form-check-label {
    font-size: 0.9rem;
    line-height: 1.4;
}
</style>
{% endblock %}